"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[3082],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>f});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=u(n),d=r,f=p["".concat(s,".").concat(d)]||p[d]||m[d]||o;return n?a.createElement(f,i(i({ref:t},c),{},{components:n})):a.createElement(f,i({ref:t},c))}));function f(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[p]="string"==typeof e?e:r,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3812:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>o,metadata:()=>l,toc:()=>u});var a=n(7462),r=(n(7294),n(3905));const o={sidebar_position:8,title:"NDMF Processor"},i="Functions: NDMF Processor",l={unversionedId:"products/animator-as-code/functions/ndmf-processor",id:"products/animator-as-code/functions/ndmf-processor",title:"NDMF Processor",description:"This is the work-in-progress documentation for Animator As Code V1, which has not yet been released. The last public version of Animator As Code is V0.",source:"@site/docs/products/animator-as-code/functions/ndmf-processor.md",sourceDirName:"products/animator-as-code/functions",slug:"/products/animator-as-code/functions/ndmf-processor",permalink:"/docs/products/animator-as-code/functions/ndmf-processor",draft:!1,tags:[],version:"current",sidebarPosition:8,frontMatter:{sidebar_position:8,title:"NDMF Processor"},sidebar:"tutorialSidebar",previous:{title:"Modular Avatar",permalink:"/docs/products/animator-as-code/functions/modular-avatar"},next:{title:"Barebones way",permalink:"/docs/products/animator-as-code/reference-barebones"}},s={},u=[{value:"Example",id:"example",level:2},{value:"Use a shared Direct Blend Tree",id:"use-a-shared-direct-blend-tree",level:2},{value:"How to use",id:"how-to-use",level:2},{value:"Plugin (AacPlugin&lt;T&gt; where T : MonoBehaviour)",id:"plugin-aacplugint-where-t--monobehaviour",level:2},{value:"Properties",id:"properties",level:3},{value:"Overrides",id:"overrides",level:3},{value:"NDMF Sequence",id:"ndmf-sequence",level:2},{value:"In BuildPhase.Generating",id:"in-buildphasegenerating",level:4}],c={toc:u},p="wrapper";function m(e){let{components:t,...n}=e;return(0,r.kt)(p,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"functions-ndmf-processor"},"Functions: NDMF Processor"),(0,r.kt)("admonition",{type:"danger"},(0,r.kt)("p",{parentName:"admonition"},"This is the work-in-progress documentation for Animator As Code ",(0,r.kt)("strong",{parentName:"p"},"V1"),", which has not yet been released. The last public version of Animator As Code is V0.")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"The API contract for Modular Avatar As Code V1 is highly unstable. Use at your own risk.")),(0,r.kt)("p",null,"This integration lets you write scripts that run when an avatar is being processed by ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/bdunderscore/ndmf"},"NDMF (Non-Destructive Modular Framework)"),". An Animator As Code instance (",(0,r.kt)("inlineCode",{parentName:"p"},"AacFlBase"),") is provided for you."),(0,r.kt)("h2",{id:"example"},"Example"),(0,r.kt)("p",null,"Here's an example of a toggle written with the NDMF Processor:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'#if UNITY_EDITOR\nusing ModularAvatarAsCode.V1;\nusing nadena.dev.ndmf;\nusing NdmfAsCode.V1.Example;\nusing UnityEngine;\nusing VRC.SDK3.Avatars.Components;\n\n[assembly: ExportsPlugin(typeof(AacToggleProcessor))]\nnamespace NdmfAsCode.V1.Example\n{\n    public class NdmfAsCodeToggle : MonoBehaviour\n    {\n        public string parameter;\n        public GameObject[] objects;\n        public Texture2D icon;\n    }\n\n    public class AacToggleProcessor : AacPlugin<NdmfAsCodeToggle>\n    {\n        protected override AacPluginOutput Execute()\n        {\n            var ctrl = aac.NewAnimatorController();\n            var fx = ctrl.NewLayer();\n            \n            var off = fx.NewState("OFF").WithAnimation(aac.NewClip().Toggling(my.objects, false));\n            var on = fx.NewState("ON").WithAnimation(aac.NewClip().Toggling(my.objects, true));\n\n            var param = fx.BoolParameter(my.parameter);\n            off.TransitionsTo(on).When(param.IsTrue());\n            on.TransitionsTo(off).When(param.IsFalse());\n\n            var maAc = MaAc.Create(my.gameObject);\n            maAc.NewMergeAnimator(ctrl, VRCAvatarDescriptor.AnimLayerType.FX);\n            maAc.NewParameter(param);\n            maAc.EditMenuItemOnSelf().Toggle(param).Name(my.name).WithIcon(my.icon);\n\n            return AacPluginOutput.Regular();\n        }\n    }\n}\n#endif\n')),(0,r.kt)("h2",{id:"use-a-shared-direct-blend-tree"},"Use a shared Direct Blend Tree"),(0,r.kt)("p",null,"If you're familiar with the concept of sharing a Direct Blend Tree, the processor can merge them all for you, across all scripts that use ",(0,r.kt)("inlineCode",{parentName:"p"},"AacPlugin"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"#if UNITY_EDITOR\nusing ModularAvatarAsCode.V1;\nusing nadena.dev.ndmf;\nusing NdmfAsCode.V1.Example;\nusing UnityEngine;\nusing VRC.SDK3.Avatars.Components;\n\n[assembly: ExportsPlugin(typeof(AacToggleProcessor))]\nnamespace NdmfAsCode.V1.Example\n{\n    public class NdmfAsCodeToggleDBT : MonoBehaviour\n    {\n        public string parameter;\n        public GameObject[] objects;\n        public Texture2D icon;\n    }\n\n    public class AacToggleDBTProcessor : AacPlugin<NdmfAsCodeToggleDBT>\n    {\n        protected override AacPluginOutput Execute()\n        {\n            // Since this does not produce a layer but still needs Float parameters, use NoAnimator().\n            // NDMF Processor will create the necessary parameters into the direct blend tree animator.\n            var param = aac.NoAnimator().FloatParameter(my.parameter);\n            \n            var bt = aac.NewBlendTree()\n                .Simple1D(param)\n                .WithAnimation(aac.NewClip().Toggling(my.objects, false), 0)\n                .WithAnimation(aac.NewClip().Toggling(my.objects, true), 1);\n\n            var maAc = MaAc.Create(my.gameObject);\n            // Blend Trees use a Float parameter, but the Expression Parameter can declare it as a bool.\n            // Use the functions NewBoolToFloatParameter(...) and ToggleBoolToFloat(...) to reuse the parameter\n            maAc.NewBoolToFloatParameter(param);\n            maAc.EditMenuItemOnSelf().ToggleBoolToFloat(param).Name(my.name).WithIcon(my.icon);\n            \n            // TODO: We need a way to store override values! Such as One = 1, or Smoothing = 0.8.\n            // This may need to be added in the output object\n            return AacPluginOutput.DirectBlendTree(VRCAvatarDescriptor.AnimLayerType.FX, bt);\n        }\n    }\n}\n#endif\n")),(0,r.kt)("h2",{id:"how-to-use"},"How to use"),(0,r.kt)("p",null,"To use NDMF Processor:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Create a new MonoBehaviour class."),(0,r.kt)("li",{parentName:"ul"},"Create a new class that inherits from ",(0,r.kt)("inlineCode",{parentName:"li"},"AacPlugin<YourBehaviour>")),(0,r.kt)("li",{parentName:"ul"},"Override the method ",(0,r.kt)("inlineCode",{parentName:"li"},"protected override AacPluginOutput Execute()")),(0,r.kt)("li",{parentName:"ul"},"Use the ",(0,r.kt)("inlineCode",{parentName:"li"},"aac")," field to access an instance of AAC."),(0,r.kt)("li",{parentName:"ul"},"Use the ",(0,r.kt)("inlineCode",{parentName:"li"},"my")," field to access your MonoBehaviour instance."),(0,r.kt)("li",{parentName:"ul"},"Make the method ",(0,r.kt)("inlineCode",{parentName:"li"},"return AacPluginOutput.Regular();"))),(0,r.kt)("p",null,"To use that processor, add new component somewhere in your avatar that uses that behaviour."),(0,r.kt)("p",null,"You can have multiple of these, and the script will be executed for each instance."),(0,r.kt)("h2",{id:"plugin-aacplugint-where-t--monobehaviour"},"Plugin (AacPlugin<T",">"," where T : MonoBehaviour)"),(0,r.kt)("p",null,"Define ",(0,r.kt)("inlineCode",{parentName:"p"},"T")," to be your MonoBehaviour component."),(0,r.kt)("h3",{id:"properties"},"Properties"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"protected AacFlBase aac { get; private set; }")," ",(0,r.kt)("br",null),"\nThis field contains the Animator As Code instance. To customize the configuration, see ",(0,r.kt)("a",{parentName:"p",href:"#overrides"},"Overrides")," below.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"protected T my { get; private set; }")," ",(0,r.kt)("br",null),"\nThis field contains the instance of your targeted script being processed.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"protected BuildContext buildContext { get; private set; }")," ",(0,r.kt)("br",null),"\nThis field contains the build context of NDMF."))),(0,r.kt)("h3",{id:"overrides"},"Overrides"),(0,r.kt)("p",null,"You may override those methods if necessary:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"protected virtual string SystemName(Component script, BuildContext context) => GetType().Name;")," ",(0,r.kt)("br",null),"\nGenerated layers will be prefixed with the system name.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"protected virtual Transform AnimatorRoot(Component script, BuildContext context) => context.AvatarRootTransform;")," ",(0,r.kt)("br",null),"\nThe root transform is used to determine the relative paths to the object references that will be used within the animation. If you want to reuse a component on multiple avatars without reassigning the references, you can override this behaviour.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"protected virtual Transform DefaultValueRoot(Component script, BuildContext context) => context.AvatarRootTransform;")," ",(0,r.kt)("br",null),"\n(At the moment, the DefaultValueRoot is not used in Animator As Code. It is meant to be used for sampling the default values of animated properties, so it may be different from the AnimatorRoot above)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"protected virtual bool UseWriteDefaults(Component script, BuildContext context) => false;")," ",(0,r.kt)("br",null),"\nChoose the WriteDefaults state that will be used by default when creating states."))),(0,r.kt)("h2",{id:"ndmf-sequence"},"NDMF Sequence"),(0,r.kt)("h4",{id:"in-buildphasegenerating"},"In BuildPhase.Generating"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"All user plugins inheriting from ",(0,r.kt)("inlineCode",{parentName:"li"},"AacPlugin<T>")," run before plugin ",(0,r.kt)("inlineCode",{parentName:"li"},"NdmfAacDBTPlugin")," does."),(0,r.kt)("li",{parentName:"ul"},"The plugin ",(0,r.kt)("inlineCode",{parentName:"li"},"NdmfAacDBTPlugin")," collects all direct blend trees declared by user plugins."),(0,r.kt)("li",{parentName:"ul"},"Plugins are expected to generate Modular Avatar components. Modular Avatar components belong in the Transforming build phase.")))}m.isMDXComponent=!0}}]);